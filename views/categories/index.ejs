<% layout('layouts/boilerplate') -%>

<div class="container-fluid px-4">
  <h1 class="mt-4 mb-4">Categories Management</h1>
  <div class="row g-4">
    <!-- Left Column: Forms -->
    <div class="col-12 col-lg-3">

      <!-- Parent Category Form -->
      <div class="card border mb-3">
        <div class="card-header bg-primary text-white fw-semibold">Add Parent Category</div>
        <div class="card-body">
          <form action="/categories" method="POST">
            <div class="mb-3">
              <label class="form-label fw-semibold">Category Name <span class="text-danger">*</span></label>
              <input type="text" name="name" class="form-control form-control-sm" placeholder="e.g., Summer Collection" required>
            </div>
            <input type="hidden" name="parent">
            <button type="submit" class="btn btn-primary w-100">Add Parent</button>
          </form>
        </div>
      </div>

      <!-- Child Category Form -->
      <div class="card border">
        <div class="card-header bg-primary text-white fw-semibold">Add Child Category</div>
        <div class="card-body">
          <form action="/categories" method="POST">
            <div class="mb-3">
              <label class="form-label fw-semibold">Category Name <span class="text-danger">*</span></label>
              <input type="text" name="name" class="form-control form-control-sm" placeholder="e.g., T-Shirts" required>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Select Parent</label>
              <select name="parent" class="form-select form-select-sm" required>
                <option value="" disabled selected>— Choose Parent Category —</option>
                <% categories.filter(c => !c.parent).forEach(parent => { %>
                  <option value="<%= parent._id %>"><%= parent.name %></option>
                <% }) %>
              </select>
            </div>
            <button type="submit" class="btn btn-primary w-100">Add Child</button>
          </form>
        </div>
      </div>

    </div>

    <!-- Right Column: Child Categories Table -->
    <div class="col-12 col-lg-9">
      <div class="card border h-100">
        <div class="card-header bg-primary text-white fw-semibold text-center">Child Categories Overview</div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-bordered  table-hover table-sm align-middle mb-0 text-center">
              <thead class="table-light fs-7">
                <tr>
                  <th>Parent Category</th>
                  <th>Child Category</th>
                  <th>Date Added</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% if(childCategories.length > 0) { %>
                  <% childCategories.forEach(child => {
                    const parent = categories.find(p => p._id.toString() === child.parent.toString()); %>
                    <tr>
                      <td><%= parent ? parent.name : 'N/A' %></td>
                      <td><%= child.name %></td>
                      <td><%= new Date(child.createdAt).toLocaleDateString() %></td>
                      <td>
                        <form action="/categories/<%= child._id %>?_method=DELETE" method="POST" class="d-inline">
                          <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete <%= child.name %>?')">Delete</button>
                        </form>
                      </td>
                    </tr>
                  <% }) %>
                <% } else { %>
                  <tr>
                    <td colspan="4" class="text-muted py-3">No child categories found.</td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <nav class="mt-3">
            <ul class="pagination justify-content-center mb-0">
              <% if(pagination.currentPage > 1){ %>
                <li class="page-item"><a class="page-link" href="?page=<%= pagination.currentPage - 1 %>">Previous</a></li>
              <% } else { %>
                <li class="page-item disabled"><span class="page-link">Previous</span></li>
              <% } %>

              <% for(let i = 1; i <= pagination.totalPages; i++){ %>
                <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
                  <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                </li>
              <% } %>

              <% if(pagination.currentPage < pagination.totalPages){ %>
                <li class="page-item"><a class="page-link" href="?page=<%= pagination.currentPage + 1 %>">Next</a></li>
              <% } else { %>
                <li class="page-item disabled"><span class="page-link">Next</span></li>
              <% } %>
            </ul>
          </nav>
        </div>
      </div>
    </div>

  </div>
</div>
