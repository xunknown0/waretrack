<% layout('layouts/boilerplate') -%>

<div class="container-fluid px-4 mt-4" style="font-size:0.85rem; font-family:'Times New Roman', serif">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h1 class="fw-bold text-dark mb-0 small"><i class="fa fa-box me-2"></i> Products</h1>
    <div class="d-flex gap-2 flex-wrap">
      <form class="d-flex gap-1" method="GET" action="/products">
        <input type="search" class="form-control form-control-sm" placeholder="Search..." name="search" value="<%= search %>">
        <input type="date" class="form-control form-control-sm" name="date" value="<%= date %>">
        <button class="btn btn-sm btn-primary"><i class="fa fa-search"></i></button>
        <a href="/products" class="btn btn-sm btn-secondary"><i class="fa fa-sync-alt"></i></a>
      </form>
      <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
        <i class="fa fa-plus-circle me-1"></i> Add Product
      </button>
    </div>
  </div>

  <!-- Table -->
  <table class="table table-striped table-hover table-sm align-middle text-center mb-0">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>SKU</th>
        <th>Name</th>
        <th>Category</th>
        <th>Stock</th>
        <th>Price</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% if(products.length){ %>
        <% products.forEach((p,i)=>{ %>
        <tr>
          <td><%= (currentPage-1)*10 + i +1 %></td>
          <td><%= p.sku %></td>
          <td><%= p.title %></td>
          <td><%= p.category ? p.category.name : '-' %></td>
          <td><%= p.stock %></td>
          <td>₱<%= Number(p.price).toLocaleString() %></td>
          <td class="<%= p.stock<=0?'text-danger':p.stock<=5?'text-warning':'text-success' %>">
            <%= p.stock<=0?'Out of Stock':p.stock<=5?'Low':'In Stock' %>
          </td>
          <td>
            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#viewProductModal-<%= p._id %>"><i class="fa fa-eye"></i></button>
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editProductModal-<%= p._id %>"><i class="fa fa-edit"></i></button>
            <form action="/products/<%= p._id %>?_method=DELETE" method="POST" class="d-inline">
              <button type="submit" class="btn btn-sm btn-danger"><i class="fa fa-trash"></i></button>
            </form>
          </td>
        </tr>

        <!-- View Modal -->
        <div class="modal fade" id="viewProductModal-<%= p._id %>">
          <div class="modal-dialog modal-md modal-dialog-centered">
            <div class="modal-content rounded-3 small">
              <div class="modal-header">
                <h5 class="modal-title"><%= p.title %></h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body text-start">
                <p><strong>SKU:</strong> <%= p.sku %></p>
                <p><strong>Category:</strong> <%= p.category ? p.category.name : '-' %></p>
                <p><strong>Stock:</strong> <%= p.stock %></p>
                <p><strong>Price:</strong> ₱<%= Number(p.price).toLocaleString() %></p>
                <p><strong>Description:</strong> <%= p.description %></p>
                <% if(p.image && p.image.data){ %>
                  <img src="data:<%= p.image.contentType %>;base64,<%= p.image.data.toString('base64') %>" class="img-fluid rounded mt-2" style="max-height:150px;">
                <% } %>
              </div>
              <div class="modal-footer">
                <button class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
  <!-- Edit Product Modal -->
<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal-<%= p._id %>">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content rounded-3">

      <!-- Modal Header -->
      <div class="modal-header border-0">
        <h5 class="modal-title"><i class="fa fa-edit me-2"></i> Edit Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- Modal Form -->
      <form action="/products/<%= p._id %>?_method=PUT" method="POST" enctype="multipart/form-data">
        <div class="modal-body">

          <!-- Product Title -->
          <div class="mb-2">
            <label class="form-label">Title</label>
            <input type="text" name="title" class="form-control" value="<%= p.title %>" placeholder="Product Name" required>
          </div>

          <!-- Category
          <div class="mb-2">
            <label class="form-label">Category</label>
            <select name="category" class="form-control" required>
              <option value="" disabled>Select Category</option>
              <% categories.forEach(cat => { %>
                <option value="<%= cat._id %>" <%= p.category && (p.category._id.toString() === cat._id.toString()) ? 'selected':'' %>>
                  <%= cat.name %>
                </option>
              <% }) %>
            </select>
          </div> -->

          <!-- Stock -->
          <div class="mb-2">
            <label class="form-label">Stock</label>
            <input type="number" name="stock" class="form-control" value="<%= p.stock %>" min="0" placeholder="0">
          </div>

          <!-- Price -->
          <div class="mb-2">
            <label class="form-label">Price</label>
            <input type="number" name="price" class="form-control" value="<%= p.price %>" step="0.01" min="0" placeholder="0.00">
          </div>

          <!-- Description -->
          <div class="mb-2">
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" placeholder="Description"><%= p.description %></textarea>
          </div>

          <!-- Image Upload -->
          <div class="mb-2">
            <label class="form-label">Image</label>
            <input type="file" name="image" class="form-control" onchange="previewImage(event, 'editPreview-<%= p._id %>')">
          </div>

          <!-- Image Preview -->
          <% if(p.image && p.image.data){ %>
            <img id="editPreview-<%= p._id %>" 
                 src="data:<%= p.image.contentType %>;base64,<%= p.image.data.toString('base64') %>" 
                 class="img-fluid rounded mb-2" style="max-height:150px; width:auto;">
          <% } else { %>
            <img id="editPreview-<%= p._id %>" class="img-fluid rounded mb-2" style="max-height:150px; display:none;">
          <% } %>

        </div>

        <!-- Modal Footer -->
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>

      </form>
    </div>
  </div>
</div>

<script>

</script>


        <% }) %>
      <% } else { %>
        <tr><td colspan="8" class="text-center text-muted">No products found.</td></tr>
      <% } %>
    </tbody>
  </table>

  <!-- Pagination -->
  <nav class="mt-2">
    <ul class="pagination pagination-sm justify-content-center">
      <% if(currentPage>1){ %>
        <li class="page-item"><a class="page-link" href="?page=<%= currentPage-1 %>&search=<%= search %>&date=<%= date %>">&laquo;</a></li>
      <% } else { %>
        <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
      <% } %>

      <% for(let i=1;i<=totalPages;i++){ %>
        <li class="page-item <%= i===currentPage?'active':'' %>"><a class="page-link" href="?page=<%= i %>&search=<%= search %>&date=<%= date %>"><%= i %></a></li>
      <% } %>

      <% if(currentPage<totalPages){ %>
        <li class="page-item"><a class="page-link" href="?page=<%= currentPage+1 %>&search=<%= search %>&date=<%= date %>">&raquo;</a></li>
      <% } else { %>
        <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
      <% } %>
    </ul>
  </nav>
</div>

<%- include('../partials/modals/productModal') %>